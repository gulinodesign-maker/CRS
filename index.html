<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>CRS Score</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / Manifest -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#000000">

  <!-- iOS specifico (iPhone / iPad) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="crs-icon.png">
  <link rel="icon" href="crs-icon.png" type="image/png">

  <style>
  :root {
    --coyote-red:#CC0000;
    --coyote-yellow:#FDE000;
    --bg-dark:#000000;
    --bg-card:#ffffff;
    --text-main:#111827;
  }

  * { box-sizing:border-box; }
  /* ACCESSIBILIT√Ä: evidenziazione focus tastiera */
  :focus-visible {
    outline: 2px solid var(--coyote-yellow);
    outline-offset: 2px;
  }
  button:focus-visible,
  .home-btn:focus-visible,
  .btn:focus-visible,
  .participant-row:focus-visible,
  .test-tab:focus-visible {
    outline: 2px solid var(--coyote-yellow);
    outline-offset: 2px;
  }


  
@media (max-width: 360px) {
  body {
    padding: 12px;
  }
  /* ANIMAZIONI LEGGERE COERENTI */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeInSoft {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  .fade-in-up {
    animation: fadeInUp 0.28s ease-out;
  }

  .fade-in-soft {
    animation: fadeInSoft 0.22s ease-out;
  }

  .container {
    padding: 12px;
    border-radius: 12px;
  }
  .home-box {
    margin-top: 24px;
    padding: 20px 16px;
    border-radius: 24px;
  }
  .home-btn {
    font-size: 18px;
    padding: 10px 14px;
  }
  #home-account-pill {
    font-size: 18px;
    padding: 6px 12px;
  }
  .btn {
    font-size: 18px;
    padding: 10px 12px;
  }
  #test-inputs input {
    padding: 14px;
    font-size: 14px;
  }
  #test-calc-btn,
  #test-reset-btn {
    padding: 18px;
    font-size: 18px;
  }
  .race-pill-value {
    font-size: 18px;
  }
  #test-scenario-display { color: var(--coyote-red); }

  li {
    font-size: 18px;
  }
}


@media (prefers-reduced-motion: reduce) {
  * {
    scroll-behavior:auto !important;
    animation-duration:0.01ms !important;
    animation-iteration-count:1 !important;
    transition:none !important;
  }
}

body {
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg-dark);
    margin:0;
    padding:20px;
    -webkit-font-smoothing: antialiased;
  }

  /* LOADING SCREEN */
  #loading-screen {
    position:fixed;
    inset:0;
    display:flex;
    justify-content:center;
    align-items:center;
    background:#000;
    color:#fff;
    font-size:20px;
    font-weight:700;
    z-index:9999;
    text-align:center;
  }
  #loading-dots {
    display:inline-block;
    width:24px;
    text-align:left;
  }

  /* BIKERS LOADING POPUP */
  #bikers-loading-overlay {
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.6);
    z-index:9998;
  }
  .bikers-loading-box {
    background:#111827;
    color:#f9fafb;
    padding:16px 20px;
    border-radius:14px;
    font-weight:700;
    font-size:18px;
    box-shadow:0 8px 20px rgba(0,0,0,0.5);
  }
  #bikers-loading-dots {
    display:inline-block;
    width:24px;
    text-align:left;
  }

  /* AUTH OVERLAY */
  #auth-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.9);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10000;
  }
  .auth-card {
    width:100%;
    max-width:380px;
    background:#111827;
    border-radius:20px;
    padding:24px 20px 20px;
    box-shadow:0 10px 25px rgba(0,0,0,0.4);
    color:#F9FAFB;
  }
  .auth-title {
    font-size:22px;
    font-weight:800;
    margin-bottom:4px;
    text-align:center;
  }
  .auth-subtitle {
    font-size:12px;
    color:#9CA3AF;
    text-align:center;
    margin-bottom:16px;
  }
  .auth-toggle-row {
    display:flex;
    gap:8px;
    margin-bottom:12px;
  }
  .auth-toggle-btn {
    flex:1;
    padding:12px;
    border-radius:999px;
    border:1px solid #4B5563;
    background:#111827;
    color:#E5E7EB;
    font-size:18px;
    font-weight:700;
    cursor:pointer;
    transition:background 0.15s ease, color 0.15s ease, border-color 0.15s ease, transform 0.08s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 10px rgba(0,0,0,0.35);
  }
  .auth-toggle-btn.active {
    background:var(--coyote-yellow);
    color:#111827;
    border-color:var(--coyote-yellow);
  }
  .auth-toggle-btn:active { transform:scale(0.97); }
  .auth-field { margin-bottom:10px; }
  .auth-field label {
    display:block;
    font-size:12px;
    margin-bottom:4px;
    color:#E5E7EB;
  }
  .auth-field input {
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #4B5563;
    background:#020617;
    color:#F9FAFB;
    font-size:20px;
  }
  .auth-field input::placeholder { color:#6B7280; }
  .auth-button {
    width:100%;
    margin-top:14px;
    padding:16px;
    border-radius:999px;
    border:none;
    background:var(--coyote-red);
    color:#fff;
    font-weight:700;
    font-size:20px;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 12px rgba(204,0,0,0.45);
  }
  .auth-button:active { transform:scale(0.97); box-shadow:none; }
  .auth-error {
    margin-top:8px;
    font-size:12px;
    color:#F97316;
    min-height:16px;
  }

  /* MAIN APP CONTAINER */
  .container {
    max-width:480px;
    margin:0 auto;
    background:var(--bg-card);
    padding:16px;
    border-radius:14px;
    box-shadow:0 4px 16px rgba(0,0,0,0.25);
    opacity:0;
    transition:opacity 0.25s ease;
  }

  /* TRANSIZIONI TRA LE VIEW PRINCIPALI */
  .view-section {
    opacity:0;
    transform:translateY(10px);
    transition:opacity 0.22s ease-out, transform 0.22s ease-out;
  }
  .view-section.active-view {
    opacity:1;
    transform:translateY(0);
  }


  /* CLASSIFICA ‚Äì GRAFICA ‚ÄúRACING‚Äù */
  .ranking {
    background: radial-gradient(circle at top, #111 0, #111827 45%, #000 100%);
    padding:12px;
    border-radius:16px;
    margin-bottom:18px;
    border:1px solid var(--coyote-yellow);
    box-shadow:0 0 10px rgba(253,224,0,0.4);
    color:#F9FAFB;
    animation: fadeInSoft 0.28s ease-out;
  }

  .ranking-header { margin-bottom:8px; }

  .race-pills-row {
    display:flex;
    gap:8px;
    justify-content:space-between;
    margin-bottom:4px;
  }

  .race-pill {
    flex:1;
    max-width:160px;
    background:rgba(15,23,42,0.95);
    border-radius:999px;
    padding:6px 10px;
    border:1px solid rgba(253,224,0,0.5);
    box-shadow:0 0 6px rgba(253,224,0,0.3);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:space-between;
  }

  .race-pill-label {
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:0.08em;
    opacity:0.85;
  }

  .race-pill-value {
    font-size:20px;
    font-weight:700;
    margin-top:2px;
  }

  .race-top-row {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}
  .race-date {
    width:100%;
    text-align:center;
    font-weight:700;
    white-space:normal;
  }

  ol { margin:0; padding-left:0; list-style:none; }

  li {
    margin:4px 0;
    padding:8px 10px;
    border-radius:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:20px;
    position:relative;
    box-shadow:0 2px 4px rgba(0,0,0,0.25);
  }

  li:nth-child(1){ background:rgba(253,224,0,0.18); border:1px solid rgba(253,224,0,0.7);}
  li:nth-child(2){ background:rgba(248,113,113,0.16); border:1px solid rgba(248,113,113,0.5);}
  li:nth-child(3){ background:rgba(148,163,184,0.18); border:1px solid rgba(148,163,184,0.5);}
  li:nth-child(n+4){ background:rgba(15,23,42,0.6); border:1px solid rgba(30,64,175,0.4); }
  li::before {
    content:"";
    position:absolute;
    left:0;
    top:4px;
    bottom:4px;
    width:4px;
    border-radius:10px;
    background:#1d4ed8;
    opacity:0.9;
  }

  li:nth-child(1)::before {
    background:#facc15; /* oro */
  }
  li:nth-child(2)::before {
    background:#f97316; /* arancio */
  }
  li:nth-child(3)::before {
    background:#9ca3af; /* argento scuro */
  }


  .result-left {
    display:flex;
    flex-direction:column;
    gap:4px;
    flex:1;
    min-width:0;
  }

  .result-topline {
    display:flex;
    align-items:baseline;
    gap:6px;
    width:100%;
  }

  .position-number {
    font-size:24px;
    font-weight:900;
    line-height:1;
    min-width:28px;
  }

  .result-name {
    font-weight:700;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .battery-row {
    display:flex;
    align-items:center;
    gap:8px;
  }

  .result-right {
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    justify-content:space-between;
    gap:4px;
    margin-left:8px;
  }

  .right-topline {
    display:flex;
    align-items:center;
    gap:6px;
  }

  .medal { font-size:26px; line-height:1; }

  .result-score {
    font-weight:900;
    font-size:22px;
    white-space:nowrap;
    line-height:24px;
    margin-top: 3px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(248,250,252,0.3);
    box-shadow:0 0 6px rgba(0,0,0,0.5);
  }

  /* BATTERIA */
  .battery {
    width:130px;
    height:24px;
    border-radius:5px;
    border:2px solid #e5e7eb;
    position:relative;
    padding:3px;
    display:flex;
    align-items:center;
    background:rgba(15,23,42,0.9);
    overflow:hidden;
  }
  .battery::after {
    content:"";
    position:absolute;
    right:-7px;
    top:50%;
    transform:translateY(-50%);
    width:6px;
    height:12px;
    border-radius:2px;
    background:#e5e7eb;
  }
  .battery-level {
    height:100%;
    border-radius:3px;
    width:0%;
    background-color:#22c55e;
    transition:width 0.4s ease-out;
  }
  .battery-percent-label {
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    font-size:11px;
    font-weight:700;
    color:#f9fafb;
    text-shadow:0 0 4px rgba(0,0,0,0.7);
    pointer-events:none;
  }

  .player-card {
    background:#f9fafb;
    padding:10px;
    border-radius:12px;
    margin-bottom:10px;
    border:1px solid #ddd;
    animation: fadeInUp 0.22s ease-out;
  }

  .player-title {
    font-weight:700;
    margin-bottom:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .delete-biker {
    background:none;
    border:none;
    color:#dc2626;
    font-weight:bold;
    cursor:pointer;
    font-size:20px;
  }

  #db-container input,
  #players-container input,
  #race-info-container input {
    display:block;
    width:100%;
    max-width:100%;
    box-sizing:border-box;
    padding:8px;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:20px;
    margin-bottom:4px;
  }

  /* LISTA BIKERS (vista database semplificata) */
  .biker-list {
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:8px;
  }
  .biker-list-empty {
    font-size:14px;
    color:#6b7280;
    text-align:center;
    margin-top:8px;
  }
  .biker-list-item {
    width:100%;
    text-align:left;
    padding:10px 12px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    background:#f9fafb;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    transition:background 0.12s ease, box-shadow 0.12s ease, transform 0.06s ease;
  }
  .biker-list-item span.biker-initial {
    width:26px;
    height:26px;
    border-radius:999px;
    background:#111827;
    color:#f9fafb;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    font-weight:700;
  }
  .biker-list-item:hover {
    background:#e5e7eb;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
  }
  .biker-list-item:active {
    transform:scale(0.98);
    box-shadow:none;
  }

  .db-buttons-inline {
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:14px;
  }

  /* MODALE GESTIONE BIKER */
  #biker-modal-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10001;
  }
  .biker-modal {
    width:100%;
    max-width:360px;
    background:#f9fafb;
    border-radius:20px;
    padding:18px 16px 14px;
    box-shadow:0 14px 30px rgba(0,0,0,0.45);
  }
  .biker-modal-title {
    font-size:18px;
    font-weight:800;
    margin:0 0 4px;
    color:#111827;
    text-align:center;
  }
  .biker-modal-subtitle {
    font-size:12px;
    color:#6b7280;
    text-align:center;
    margin:0 0 10px;
  }
  .biker-modal-field {
    margin-bottom:8px;
  }
  .biker-modal-field label {
    display:block;
    font-size:12px;
    color:#374151;
    margin-bottom:2px;
  }
  .biker-modal-field input {
    width:100%;
    box-sizing:border-box;
    padding:8px;
    border-radius:10px;
    border:1px solid #d1d5db;
    font-size:16px;
  }
  .biker-modal-actions {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-top:10px;
  }
  .biker-modal-actions-left {
    display:flex;
    gap:8px;
  }
  .biker-modal-btn {
    flex:1;
    padding:9px 10px;
    border-radius:999px;
    border:none;
    font-size:14px;
    font-weight:700;
    cursor:pointer;
    transition:transform 0.06s ease, box-shadow 0.12s ease, background 0.12s ease;
  }
  .biker-modal-btn:active {
    transform:scale(0.97);
    box-shadow:none;
  }
  .biker-modal-btn-primary {
    background:var(--coyote-yellow);
    color:#111827;
    box-shadow:0 4px 10px rgba(253,224,71,0.4);
  }
  .biker-modal-btn-secondary {
    background:#e5e7eb;
    color:#111827;
  }
  .biker-modal-btn-danger {
    background:#fee2e2;
    color:#b91c1c;
  }

  /* STILE BARRA DATA NELLA PAGINA GARA */
  #race-date-input {
  -webkit-appearance: none;
  appearance: none;

  display: block;
  width: 100%;
  box-sizing: border-box;

  background: #e5e7eb;
  border-radius: 18px;
  border: 2px solid #ffffff;

  text-align: center;
  font-weight: 700;
  font-size: 16px;
  line-height: normal;

  padding: 14px 0;
  min-height: 50px;
}

  #race-date-input::-webkit-datetime-edit {
    text-align:center;
    padding:0;
  }
  #race-date-input::-webkit-datetime-edit-fields-wrapper {
    text-align:center;
  }


  /* SELEZIONE BIKERS ‚Äì STILE RACING */
  .participant-row {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border-radius:14px;
    background:#f9fafb;
    margin-bottom:8px;
    border:1px solid #e5e7eb;
    cursor:pointer;
    position:relative;
    overflow:hidden;
    transition:background 0.15s ease, transform 0.08s ease, box-shadow 0.15s ease, border-color 0.15s ease;
  }

  .participant-row::before {
    content:"";
    position:absolute;
    left:0;
    top:0;
    bottom:0;
    width:4px;
    background:var(--coyote-red);
    opacity:0.7;
    transition:background 0.15s ease, opacity 0.15s ease;
  }

  .participant-row:active {
    transform:scale(0.98);
  }

  .participant-row.selected {
    background:#0f172a;
    border-color:#16a34a;
    box-shadow:0 6px 18px rgba(0,0,0,0.3);
    transform:translateY(-1px);
  }

  .participant-row.selected::before {
    background:var(--coyote-yellow);
    opacity:1;
  }

  .participant-main {
    display:flex;
    align-items:center;
    gap:10px;
  }

  .participant-avatar {
    width:32px;
    height:32px;
    border-radius:999px;
    background:#111827;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:14px;
    color:var(--coyote-yellow);
    box-shadow:0 0 0 2px #111827, 0 0 8px rgba(0,0,0,0.4);
  }

  .participant-row.selected .participant-avatar {
    background:var(--coyote-red);
    color:#ffffff;
    box-shadow:0 0 0 2px #7f1d1d, 0 0 10px rgba(248,113,113,0.8);
  }

  .participant-text {
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .participant-name {
    font-weight:700;
    font-size:14px;
    color:#111827;
  }

  .participant-row.selected .participant-name {
    color:#f9fafb;
  }

  .participant-meta {
    font-size:11px;
    color:#6b7280;
  }

  .participant-row.selected .participant-meta {
    color:#e5e7eb;
  }


  /* BOTTONI */
  .buttons {
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:12px;
  }
  .btn {
    display:block;
    width:100%;
    padding:16px;
    border-radius:999px;
    border:none;
    font-weight:700;
    font-size:20px;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
    animation: fadeInUp 0.25s ease-out;
  }
  .btn:active { transform:scale(0.97); box-shadow:none; }

  #btn-db     { background:var(--coyote-yellow); color:#111; }
  #btn-select { background:var(--coyote-red); color:#fff; }
  #btn-gara   { background:var(--coyote-red); color:#fff; }
  #calc-btn   { background:var(--coyote-red); color:#fff; }
  #btn-reset  { background:#6b7280; color:#fff; }
  #save-race-button { background:var(--coyote-red); color:#fff; }

  .db-buttons-inline {
    display:flex;
    gap:8px;
    margin-top:4px;
  }
  .btn-small {
    flex:1;
    padding:14px;
    border-radius:999px;
    border:none;
    font-size:18px;
    font-weight:700;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 3px 10px rgba(0,0,0,0.25);
  }
  .btn-small:active { transform:scale(0.97); box-shadow:none; }
  .btn-db-add   { background:var(--coyote-red); color:#ffffff; }
  .btn-db-save  { background:var(--coyote-yellow); color:#111; }

  /* BANNER IN ALTO */
  #top-banner-wrap {
    width:100%;
    margin:0 0 16px 0;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  #top-banner {
    flex:1;
    width:100%;
    max-width:100%;
    height:auto;
    display:block;
    object-fit:contain;
  }

  /* MENU ICON & ACCOUNT BADGE */
  #header-right {
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:6px;
  }
  #menu-icon {
    width:32px;
    height:24px;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .menu-line { width:32px; height:4px; background:#CC0000;
    border-radius:3px;
  }
  #account-badge {
    font-size:10px;
    padding:4px 8px;
    border-radius:999px;
    background:#111827;
    color:#F9FAFB;
    border:1px solid #4B5563;
    cursor:pointer;
    max-width:120px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* HOME VIEW */
  #home-view {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    margin-top:8px;
    margin-bottom:16px;
  }

  #home-account-pill {
    background:var(--coyote-red);
    color:#ffffff;
    padding:8px 16px;
    border-radius:999px;
    font-weight:700;
    font-size:20px;
    margin-bottom:8px;
    max-width:80%;
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .home-box {
    margin-top: 40px;
    background:var(--coyote-yellow);
    border-radius:30px;
    padding:28px 22px;
    width:100%;
    max-width:420px;
    display:flex;
    flex-direction:column;
    gap:16px;
    animation: fadeInUp 0.3s ease-out;
  }

  .home-btn {
    display:block;
    width:100%;
    background:var(--coyote-red);
    color:#ffffff;
    padding:16px;
    font-size:20px;
    text-align:center;
    border-radius:999px;
    border:none;
    font-weight:700;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
  }
  .home-btn:active { transform:scale(0.97); box-shadow:none; }

  /* COLORI SPECIFICI BOTTONI HOME */
  #home-btn-race {
    background: var(--coyote-red);
    border-color: var(--coyote-red);
    color:#ffffff;
  }
  #home-btn-performance {
    background:#16a34a;
    border-color:#16a34a;
    color:#ffffff;
  }
  #home-btn-test {
    background:#0284c7;
    border-color:#0284c7;
    color:#ffffff;
  }
  #home-btn-bikers {
    background:#111827;
    border-color:#111827;
    color:#ffffff;
  }
  #home-btn-account {
    background:#4f46e5;
    border-color:#4f46e5;
    color:#ffffff;
  }

  /* TEST VIEW: box nero pi√π alto */
  #test-ranking-box {
    padding:24px;
  }


  /* Hide app container in home view */
  body.home-mode .container { display:none; }

  /* TEST VIEW */
  #test-inputs {
    margin-top:12px;
    background:#f9fafb;
    border-radius:12px;
    padding:10px;
    border:1px solid #e5e7eb;
    animation: fadeInUp 0.25s ease-out;
  }
  .test-tabs {
    display:flex;
    gap:6px;
    margin-bottom:8px;
  }
  .test-tab {
    flex:1;
    padding:10px;
    border-radius:999px;
    border:1px solid var(--coyote-yellow);
    background:#fef9c3;
    font-size:20px;
    font-weight:700;
    cursor:pointer;
    color:#111827;
    transition:background 0.15s ease, color 0.15s ease, transform 0.08s ease;
  }
  .test-tab:active { transform:scale(0.97); }
  .test-tab.active {
    background:var(--coyote-yellow);
    color:#111827;
    border-color:var(--coyote-yellow);
  }
  .test-tab-icon {
    display:block;
    font-size:24px;
    line-height:1;
  }
  .test-tab-contents { margin-top:4px; }
  .test-tab-content { display:none; }
  .test-tab-content.active { display:block; }
  #test-inputs input {
    width:100%;
    padding:20px;
    border-radius:8px;
    border:1px solid #d1d5db;
    font-size:16px;
    font-weight:700;
    box-sizing:border-box;
  }
  #test-calc-btn, #test-reset-btn {
    margin-top:10px;
    width:100%;
    padding:20px;
    border-radius:999px;
    border:none;
    font-weight:700;
    font-size:20px;
    cursor:pointer;
    transition:transform 0.08s ease, opacity 0.12s ease, box-shadow 0.12s ease;
    box-shadow:0 4px 12px rgba(0,0,0,0.25);
  }
  #test-calc-btn { background:#16a34a; color:#fff; }
  #test-reset-btn { background:#dc2626; color:#fff; }
  #test-calc-btn:active, #test-reset-btn:active { transform:scale(0.97); }

  #test-view .race-pills-row { justify-content:center; }
  #test-view .race-pill { max-width:none; min-width:200px; text-align:center; }
  #test-view .race-pill-value { font-size:24px; font-weight:800; }

  /* Pillole valori Test Algoritmo sotto la batteria */
  .test-data-pills {
    display:flex;
    gap:6px;
    margin-top:6px;
    flex-wrap:wrap;
  }
  .test-data-pill {
    flex:1;
    padding: 16px 8px;
    border-radius:999px;
    text-align:center;
    background:#020617;
    color:var(--coyote-red);
    font-size:14px;
    font-weight:700;
    border:1px solid rgba(248,113,113,0.7);
    box-shadow:0 0 4px rgba(0,0,0,0.5);
  }

  /* CALENDARIO PERFORMANCE COME POPUP GRANDE */
  #race-calendar {
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    z-index:9998;
    width:calc(100% - 80px);
    max-width:480px;
  }

  /* HEADER GARA SPECIFICA (CHIARO) */
  #performance-race-header {
    background:#fefce8;
    color:#111827;
    box-shadow:0 0 8px rgba(253,224,0,0.4);
  }
  #performance-race-header .race-pill {
    background:#f3f4f6;
    color:#111827;
    border:1px solid #e5e7eb;
    box-shadow:none;
  }
  #performance-race-header .race-pill-label,
  #performance-race-header .race-pill-value { color:#111827; }
  #performance-race-header .race-top-row {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}
  
/* Fix stronger centering for date input */
#race-date-input {
  text-align-last:center;
}

#race-date-input::-webkit-date-and-time-value {
  text-align: center;
  min-height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}


/* CORREZIONE BARRA DATA ‚Äî COMPLETAMENTE CENTRATA + BORDO BIANCO */

#race-date-display {
  color: #CC0000 !important;
  font-weight: 800;
  font-size: 16px;
  text-align: center !important;
  display: block;
}



#perf-race-date-display {
  color: #CC0000 !important;
  font-weight: 800;
  font-size: 16px;
  text-align: center !important;
  display: block;
  margin-top: 10px;
}

  #home-footer {
    margin-top: 16px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  #version-label {
    font-size: 11px;
    color: var(--coyote-red);
    text-align: center;
    letter-spacing: 0.04em;
  }



  /* TEST ALGORITMO ‚Äì pillole dati, header e card risultato in grigio chiaro */
  #test-view .test-data-pill {
    background: #e5e7eb;
    color: var(--coyote-red);
    border: 1px solid #d1d5db;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
  }

  #test-view .ranking {
    background: #e5e7eb;
    border: 1px solid #d1d5db;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.20);
    color: #111827;
  }

  #test-view .ranking-header .race-pill {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.12);
    color: #111827;
  }

  #test-view .race-pill-value {
    color: #111827;
  }

  #test-ranking-box ol {
    margin: 0;
    padding-left: 0;
    list-style: none;
  }

  #test-ranking-box li {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
  }

  #test-ranking-box li::before {
    background: transparent;
  }

  #test-ranking-box li:nth-child(1),
  #test-ranking-box li:nth-child(2),
  #test-ranking-box li:nth-child(3),
  #test-ranking-box li:nth-child(n+4) {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
  }

  #test-view .position-number,
  #test-view .result-name,
  #test-view .battery-percent-label,
  #test-view .scenario-badge,
  #test-view .medal {
    color: #111827;
    text-shadow: none;
  }

  #test-view .result-score {
    background: #e5e7eb;
    color: #111827;
    border: 1px solid #d1d5db;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
  }


  /* TEST ALGORITMO ‚Äì percentuale batteria in bianco */
  #test-view .battery-percent-label {
    color: #ffffff !important;
    text-shadow: 0 0 4px rgba(0,0,0,0.7) !important;
  }


  /* POPUP LOADING PERFORMANCE */
  #loading-popup-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.65);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10002;
  }
  .loading-popup {
    background:#111827;
    color:#f9fafb;
    padding:18px 24px;
    border-radius:18px;
    box-shadow:0 15px 40px rgba(0,0,0,0.4);
    font-size:18px;
    font-weight:700;
    text-align:center;
  }
  .loading-popup-dots span {
    display:inline-block;
    animation:loadingDots 1s infinite;
  }
  .loading-popup-dots span:nth-child(2) {
    animation-delay:0.2s;
  }
  .loading-popup-dots span:nth-child(3) {
    animation-delay:0.4s;
  }
  @keyframes loadingDots {
    0%, 20% { opacity:0; }
    50%     { opacity:1; }
    100%    { opacity:0; }
  }

  #main-buttons { margin-top:100px; }
  #home-account-pill { margin-top:100px; }
  #app-version { margin-top:100px; }
</style>
</head>

<body>

<!-- LOADING -->
<div id="loading-screen">
  Caricamento<span id="loading-dots"></span>
</div>

<!-- BIKERS LOADING POPUP -->
<div id="bikers-loading-overlay">
  <div class="bikers-loading-box">
    Loading<span id="bikers-loading-dots"></span>
  </div>
</div>

<!-- AUTH OVERLAY -->
<div id="auth-overlay">
  <div class="auth-card">
    <div class="auth-title">CRS Score</div>
    <div class="auth-subtitle">Accedi o crea un account per salvare bikers e gare.</div>

    <div class="auth-toggle-row">
      <button id="auth-toggle-login" class="auth-toggle-btn active" type="button">Login</button>
      <button id="auth-toggle-register" class="auth-toggle-btn" type="button">Crea account</button>
    </div>

    <div class="auth-field">
      <label for="auth-username">Username</label>
      <input id="auth-username" type="text" autocomplete="username" placeholder="Es. marco_79">
    </div>
    <div class="auth-field">
      <label for="auth-password">Password</label>
      <input id="auth-password" type="password" autocomplete="current-password" placeholder="Inserisci password">
    </div>

    <button id="auth-submit" class="auth-button" type="button">Entra</button>
    <div id="auth-error" class="auth-error" aria-live="polite"></div>
  </div>
</div>


<div id="top-banner-wrap" style="width:100%; display:flex; justify-content:center; margin-bottom:8px;">
  <img id="top-banner" src="BANNER.jpg" alt="CRS Factory Racing" style="max-width:90%; height:auto; display:block; margin:auto;">
</div>

<div id="menu-wrap" style="width:100%; display:flex; justify-content:center; margin-bottom:16px;">
  <div id="menu-icon" role="button" aria-label="Torna alla home" tabindex="0">
    <div class="menu-line"></div>
    <div class="menu-line"></div>
    <div class="menu-line"></div>
  </div>
</div>



<div id="home-view">

  <div class="home-box">
    <button class="home-btn" id="home-btn-race">Race</button>
    <button class="home-btn" id="home-btn-performance">Performance</button>
    <button class="home-btn" id="home-btn-test">Test Algoritmo</button>
    <button class="home-btn" id="home-btn-bikers">Bikers</button>
  </div>

  <div style="height:60px;"></div>

  <div id="home-account-pill" role="button" aria-label="Gestisci account" tabindex="0"></div>

  <div id="home-footer">
    <div id="version-label"></div>
  </div>
</div>

<div class="container">
  <div class="ranking" id="ranking-box">
    <div class="ranking-header">
      <div class="race-pills-row">
        <div class="race-pill">
          <div class="race-pill-label">Km</div>
          <div class="race-pill-value" id="race-distance-display"></div>
        </div>
        <div class="race-pill">
          <div class="race-pill-label">Dislivello</div>
          <div class="race-pill-value" id="race-elevation-display"></div>
        </div>
      </div>
      <div class="race-top-row">
        <span id="race-date-display" class="race-date"></span>
      </div>
    </div>
    <ol id="ranking-list"></ol>
  </div>

  <div id="db-container"></div>

  <!-- Popup loading performance -->
  <div id="loading-popup-overlay" aria-hidden="true">
    <div class="loading-popup" role="status" aria-live="polite">
      Loading<span class="loading-popup-dots">
        <span>.</span><span>.</span><span>.</span>
      </span>
    </div>
  </div>

  <!-- Modale gestione singolo biker -->
  <div id="biker-modal-overlay">
    <div class="biker-modal" role="dialog" aria-modal="true" aria-labelledby="biker-modal-title">
      <h2 id="biker-modal-title" class="biker-modal-title">Nuovo biker</h2>
      <p class="biker-modal-subtitle">Inserisci o modifica i dati del biker.</p>

      <div class="biker-modal-field">
        <label for="biker-modal-name">Nome</label>
        <input id="biker-modal-name" type="text" placeholder="Nome biker">
      </div>
      <div class="biker-modal-field">
        <label for="biker-modal-battery">Batteria (Wh)</label>
        <input id="biker-modal-battery" type="number" step="1" placeholder="Es. 500">
      </div>
      <div class="biker-modal-field">
        <label for="biker-modal-rider">Peso biker (kg)</label>
        <input id="biker-modal-rider" type="number" step="0.5" placeholder="Es. 65">
      </div>
      <div class="biker-modal-field">
        <label for="biker-modal-bike">Peso bici (kg)</label>
        <input id="biker-modal-bike" type="number" step="0.5" placeholder="Es. 15">
      </div>

      <div class="biker-modal-actions">
        <div class="biker-modal-actions-left">
          <button id="biker-modal-cancel" type="button" class="biker-modal-btn biker-modal-btn-secondary">Annulla</button>
          <button id="biker-modal-delete" type="button" class="biker-modal-btn biker-modal-btn-danger">Elimina</button>
        </div>
        <button id="biker-modal-save" type="button" class="biker-modal-btn biker-modal-btn-primary">Salva</button>
      </div>
    </div>
  </div>

  <div id="select-container"></div>
  <div id="players-container"></div>

  <!-- Input data semplice -->
  <div id="race-info-container" style="display:none;flex-direction:column;gap:6px;">
    <input id="race-date-input" type="date" />
    <input id="race-circuit-input" type="text" placeholder="Luogo / circuito">
    <input id="race-distance-input" type="number" step="0.1" placeholder="Km percorsi">
    <input id="race-elevation-input" type="number" step="1" placeholder="Dislivello (m)">
  </div>

  <div id="performance-container" style="display:none; margin-top:16px;">
    <div id="performance-graph" style="display:flex;align-items:flex-end;gap:10px;justify-content:center;margin-top:20px;"></div>

    <h2 id="performance-title" style="font-size:16px; margin:12px 0 4px; color:var(--coyote-red); text-align:center;">
      Performance complessive
    </h2>
    <p id="performance-subtitle" style="font-size:12px; color:#374151; text-align:center; margin:0 0 8px;">
      Media pesata delle performance su tutte le gare per ogni biker.
    </p>

    <!-- HEADER GARA SELEZIONATA -->
    <div id="performance-race-header" class="ranking" style="margin-top:8px; display:none;">
      <div class="ranking-header">
        <div class="race-pills-row">
          <div class="race-pill">
            <div class="race-pill-label">Km</div>
            <div class="race-pill-value" id="perf-race-distance-display"></div>
          </div>
          <div class="race-pill">
            <div class="race-pill-label">Dislivello</div>
            <div class="race-pill-value" id="perf-race-elevation-display"></div>
          </div>
        </div>
        <div class="race-top-row">
          <span id="perf-race-date-display" class="race-date"></span>
        </div>
      </div>
    </div>

    <div id="performance-chart" style="background:#f3f4f6; border-radius:12px; padding:10px; border:1px solid #d1d5db; margin-top:8px; animation: fadeInUp 0.3s ease-out;">
      <div id="performance-bars" style="display:flex; align-items:flex-end; gap:8px; height:220px; padding:8px 4px 0;"></div>
      <div id="performance-empty" style="font-size:12px; color:#6b7280; text-align:center; margin-top:8px;">
        Nessuna gara registrata.
      </div>
      <div style="margin-top:20px; margin-bottom:10px; display:flex; justify-content:center; gap:10px; flex-wrap:nowrap;">
        <button id="performance-overall-btn"
          style="background:#FDE000; color:#111; padding:16px 28px; border:none; border-radius:999px;
                 font-weight:800; cursor:pointer; font-size:20px; min-width:90px;">
          Media
        </button>
        <button id="performance-race-btn"
          style="background:#16A34A; color:#fff; padding:16px 28px; border:none; border-radius:999px;
                 font-weight:800; cursor:pointer; font-size:20px; min-width:90px;">
          Gare
        </button>
        <button id="reset-performance-btn"
          style="background:#CC0000; color:#fff; padding:16px 28px; border:none; border-radius:999px;
                 font-weight:800; cursor:pointer; font-size:20px; min-width:90px;">
          Reset
        </button>
      </div>

      <!-- POPUP CALENDARIO GARE -->
      <div id="race-calendar"
           style="display:none; margin:10px auto 0; padding:10px;
                  border-radius:16px; background:#fff7ed; border:1px solid #fed7aa;
                  box-shadow:0 6px 18px rgba(0,0,0,0.2);">
      </div>

    </div>
  </div>

  <div id="test-view" style="display:none; margin-top:16px;">
    <div class="ranking" id="test-ranking-box">
      <div class="ranking-header">
        <div class="race-pills-row">
          <div class="race-pill">
            <div class="race-pill-value" id="test-scenario-display">Wh/kg</div>
          </div>
        </div>
      </div>
      <ol id="test-ranking-list"></ol>
    </div>

    
<div id="test-data-pills-container" style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;justify-content:center;">
  <div class="test-data-pill" id="pill-out-wh">--</div>
  <div class="test-data-pill" id="pill-out-kg">--</div>
  <div class="test-data-pill" id="pill-out-bikekg">--</div>
  <div class="test-data-pill" id="pill-out-percent">--</div>
</div>

<div id="test-inputs">
      <div class="test-tabs">
        <button type="button" class="test-tab active" data-tab="wh" aria-label="Wh batteria">
          <span class="test-tab-icon">üîã</span>
        </button>
        <button type="button" class="test-tab" data-tab="riderkg" aria-label="Peso biker (kg)">
          <span class="test-tab-icon">üö¥‚Äç‚ôÇÔ∏è</span>
        </button>
        <button type="button" class="test-tab" data-tab="bikekg" aria-label="Peso bici (kg)">
          <span class="test-tab-icon">üö≤</span>
        </button>
        <button type="button" class="test-tab" data-tab="percent" aria-label="Carica residua (%)">
          <span class="test-tab-icon">%</span>
        </button>
      </div>
      <div class="test-tab-contents">
        <div class="test-tab-content active" data-tab="wh">
          <input id="test-battery-input" type="number" step="1"
                 placeholder="Inserisci capacit√† batteria in Wh (es. 500)">
        </div>
        <div class="test-tab-content" data-tab="riderkg">
          <input id="test-weight-input" type="number" step="0.5"
                 placeholder="Inserisci peso biker in kg (es. 65)">
        </div>
        <div class="test-tab-content" data-tab="bikekg">
          <input id="test-bike-weight-input" type="number" step="0.5"
                 placeholder="Inserisci peso bici in kg (es. 15)">
        </div>
        <div class="test-tab-content" data-tab="percent">
          <input id="test-percent-input" type="number" step="1" min="0" max="100"
                 placeholder="Inserisci carica residua in % (0-100)">
        </div>
      </div>
      <button id="test-calc-btn" type="button">Test</button>
      <button id="test-reset-btn" type="button">Reset</button>
    </div>
  </div>
</div>

<div class="buttons" id="main-buttons">
  <button class="btn" id="btn-db">Gestisci database</button>
  <button class="btn" id="btn-select">Bikers partecipanti</button>
  <button class="btn" id="btn-gara">Inserisci percentuali</button>
  <button class="btn" id="calc-btn">Calcola classifica</button>
  <button class="btn" id="btn-reset">Reset</button>
  <button class="btn" id="save-race-button">Invia dati</button>
</div>

<script>
"use strict";

const APP_VERSION = "3.27";
const BUILD_DATE = "2025-12-10-3.27";
const API_URL = "https://script.google.com/macros/s/AKfycbyIJtsBxN25dbU20AicBxfGa7sdAizTJn3f1tFSSsiA9c1M1Ce1q5kUcXSmAQfd0UR3/exec";

const USER_ID_STORAGE_KEY = "crs_userId_v2";
const USERNAME_STORAGE_KEY = "crs_username_v2";

window.__bikersCache = [];
let MAX_BIKERS = 20;


// ===== Nuovo algoritmo CRS Score basato su peso relativo =====
const BASE_RIDER_WEIGHT_KG = 65;
const BASE_BIKE_WEIGHT_KG = 15;
const BASE_TOTAL_WEIGHT_KG = BASE_RIDER_WEIGHT_KG + BASE_BIKE_WEIGHT_KG;


function computeCoyoteScore(batteryWh, totalWeightKg, percentRemaining) {
  const battery = parseFloat(batteryWh);
  const totalWeight = parseFloat(totalWeightKg);
  let percent = parseFloat(percentRemaining);

  if (!Number.isFinite(battery) || battery <= 0) return null;
  if (!Number.isFinite(totalWeight) || totalWeight <= 0) return null;
  if (!Number.isFinite(percent)) return null;

  if (percent < 0) percent = 0;
  if (percent > 100) percent = 100;

  // 1) Wh consumati (NON rimanenti)
  const consumedWh  = battery * (1 - percent / 100);
  const remainingWh = battery * (percent / 100); // solo informativo

  // se praticamente non ha consumato, evitiamo numeri assurdi
  if (consumedWh <= 0) return null;

  // 2) Normalizzazione al peso standard (80 kg)
  // Wh_cons_norm = Wh_cons * (Peso_std / Peso_tot)
  const normalizedConsumedWh = consumedWh * (BASE_TOTAL_WEIGHT_KG / totalWeight);

  // 3) Efficienza Wh/kg reale (dato per pannello Test)
  const efficiencyWhPerKg = totalWeight > 0 ? (consumedWh / totalWeight) : Infinity;

  // 4) Coyote Score: pi√π sei efficiente (meno Wh consumati normalizzati), pi√π il punteggio sale
  const SCORE_SCALE = 1000; // fattore di scala per numeri "comodi"
  const score = SCORE_SCALE / normalizedConsumedWh;

  if (!Number.isFinite(score)) return null;

  return { percent, consumedWh, remainingWh, efficiencyWhPerKg, score };
}
// ===== Fine nuovo algoritmo =====


/* Loading dots */
let loadingDotCount = 0;
const loadingInterval = setInterval(() => {
  const dots = document.getElementById("loading-dots");
  if (dots) {
    loadingDotCount = (loadingDotCount + 1) % 4;
    dots.textContent = ".".repeat(loadingDotCount);
  }
}, 400);

/* Bikers loading popup */
let bikersLoadingInterval = null;
function showBikersLoading() {
  const overlay = document.getElementById("bikers-loading-overlay");
  const dots = document.getElementById("bikers-loading-dots");
  if (!overlay || !dots) return;
  overlay.style.display = "flex";
  let count = 0;
  if (bikersLoadingInterval) clearInterval(bikersLoadingInterval);
  bikersLoadingInterval = setInterval(() => {
    count = (count + 1) % 4;
    dots.textContent = ".".repeat(count);
  }, 400);
}
function hideBikersLoading() {
  const overlay = document.getElementById("bikers-loading-overlay");
  const dots = document.getElementById("bikers-loading-dots");
  if (overlay) overlay.style.display = "none";
  if (dots) dots.textContent = "";
  if (bikersLoadingInterval) {
    clearInterval(bikersLoadingInterval);
    bikersLoadingInterval = null;
  }
}

/* REFERENCES */
const dbContainer = document.getElementById("db-container");
const loadingPopupOverlay = document.getElementById("loading-popup-overlay");

const bikerModalOverlay = document.getElementById("biker-modal-overlay");
const bikerModalTitle   = document.getElementById("biker-modal-title");
const bikerModalName    = document.getElementById("biker-modal-name");
const bikerModalBattery = document.getElementById("biker-modal-battery");
const bikerModalRider   = document.getElementById("biker-modal-rider");
const bikerModalBike    = document.getElementById("biker-modal-bike");
const bikerModalBtnSave   = document.getElementById("biker-modal-save");
const bikerModalBtnDelete = document.getElementById("biker-modal-delete");
const bikerModalBtnCancel = document.getElementById("biker-modal-cancel");

const selectContainer = document.getElementById("select-container");
const playersContainer = document.getElementById("players-container");
const raceInfoContainer = document.getElementById("race-info-container");
const rankingList = document.getElementById("ranking-list");
const rankingBox = document.getElementById("ranking-box");
const saveRaceButton = document.getElementById("save-race-button");

const homeView = document.getElementById("home-view");
const homeBtnRace = document.getElementById("home-btn-race");
const homeBtnPerformance = document.getElementById("home-btn-performance");
const homeBtnTest = document.getElementById("home-btn-test");
const homeBtnBikers = document.getElementById("home-btn-bikers");
const homeAccountPill = document.getElementById("home-account-pill");

const mainButtons = document.getElementById("main-buttons");
const btnDb = document.getElementById("btn-db");
const btnSelect = document.getElementById("btn-select");
const btnGara = document.getElementById("btn-gara");
const calcBtn = document.getElementById("calc-btn");
const btnReset = document.getElementById("btn-reset");

const raceDateInput = document.getElementById("race-date-input");
if (raceDateInput) raceDateInput.addEventListener("change", updateRaceDateDisplay);
const raceCircuitInput = document.getElementById("race-circuit-input");
const raceDistanceInput = document.getElementById("race-distance-input");
const raceElevationInput = document.getElementById("race-elevation-input");

const raceDateDisplay = document.getElementById("race-date-display");
const raceDistanceDisplay = document.getElementById("race-distance-display");
const raceElevationDisplay = document.getElementById("race-elevation-display");

const performanceContainer = document.getElementById("performance-container");
const performanceBars = document.getElementById("performance-bars");
const performanceEmpty = document.getElementById("performance-empty");
const performanceTitle = document.getElementById("performance-title");
const performanceSubtitle = document.getElementById("performance-subtitle");
const performanceOverallBtn = document.getElementById("performance-overall-btn");
const performanceRaceBtn = document.getElementById("performance-race-btn");
const raceCalendar = document.getElementById("race-calendar");

const performanceRaceHeader = document.getElementById("performance-race-header");
const perfRaceDateDisplay = document.getElementById("perf-race-date-display");
const perfRaceDistanceDisplay = document.getElementById("perf-race-distance-display");
const perfRaceElevationDisplay = document.getElementById("perf-race-elevation-display");

/* TEST */
const testView = document.getElementById("test-view");
const testRankingList = document.getElementById("test-ranking-list");
const testBatteryInput = document.getElementById("test-battery-input");
const testWeightInput = document.getElementById("test-weight-input");
const testBikeWeightInput = document.getElementById("test-bike-weight-input");
const testPercentInput = document.getElementById("test-percent-input");
const testCalcBtn = document.getElementById("test-calc-btn");
const testResetBtn = document.getElementById("test-reset-btn");
const testTabs = document.querySelectorAll(".test-tab");
const testTabContents = document.querySelectorAll(".test-tab-content");

testTabs.forEach((tab) => {
  tab.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      tab.click();
    }
  });
});


/* AUTH & ACCOUNT */
const authOverlay = document.getElementById("auth-overlay");
const authToggleLogin = document.getElementById("auth-toggle-login");
const authToggleRegister = document.getElementById("auth-toggle-register");
const authUsernameInput = document.getElementById("auth-username");
const authPasswordInput = document.getElementById("auth-password");
const authSubmitButton = document.getElementById("auth-submit");
const authErrorLabel = document.getElementById("auth-error");
const accountBadge = document.getElementById("account-badge");
const versionLabel = document.getElementById("version-label");

const viewSections = [
  dbContainer,
  selectContainer,
  playersContainer,
  raceInfoContainer,
  performanceContainer,
  testView,
  rankingBox
];
viewSections.forEach((v) => {
  if (v) v.classList.add("view-section");
});


let authMode = "login";
let selectedIndices = {};
let currentView = "home";
let allRaces = [];
let performanceMode = "overall";
let currentRaceSample = null;

/* ACCOUNT UTILS */
function getCurrentUserId() {
  return localStorage.getItem(USER_ID_STORAGE_KEY);
}
function getCurrentUsername() {
  return localStorage.getItem(USERNAME_STORAGE_KEY) || "";
}
function setCurrentUser(userId, username) {
  localStorage.setItem(USER_ID_STORAGE_KEY, userId);
  localStorage.setItem(USERNAME_STORAGE_KEY, username || "");
  updateAccountBadge();
  updateHomeAccountPill();
}
function clearCurrentUser() {
  localStorage.removeItem(USER_ID_STORAGE_KEY);
  localStorage.removeItem(USERNAME_STORAGE_KEY);
  updateAccountBadge();
  updateHomeAccountPill();
}
function updateAccountBadge() {
  if (!accountBadge) return;
  const uid = getCurrentUserId();
  const name = getCurrentUsername();
  if (!uid) accountBadge.textContent = "Nessun account";
  else accountBadge.textContent = name ? ("@" + name) : uid;
}


function updateHomeAccountPill() {
  if (!homeAccountPill) return;
  const uid = getCurrentUserId();
  const name = getCurrentUsername();
  if (!uid) {
    homeAccountPill.textContent = "Nessun account";
    homeAccountPill.style.opacity = "0.6";
  } else {
    homeAccountPill.textContent = name ? ("@" + name) : uid;
    homeAccountPill.style.opacity = "1";
  }
}

if (versionLabel) {
  versionLabel.textContent = "Versione " + APP_VERSION;
}

updateAccountBadge();
updateHomeAccountPill();


/* AUTH UI */
function showAuthOverlay(message) {
  if (authOverlay) {
    authOverlay.style.display = "flex";
    if (message && authErrorLabel) authErrorLabel.textContent = message;
  }
}
function hideAuthOverlay() {
  if (authOverlay) {
    authOverlay.style.display = "none";
    if (authErrorLabel) authErrorLabel.textContent = "";
  }
}
function setAuthMode(mode) {
  authMode = mode === "register" ? "register" : "login";
  if (!authToggleLogin || !authToggleRegister || !authSubmitButton) return;
  if (authMode === "login") {
    authToggleLogin.classList.add("active");
    authToggleRegister.classList.remove("active");
    authSubmitButton.textContent = "Entra";
  } else {
    authToggleLogin.classList.remove("active");
    authToggleRegister.classList.add("active");
    authSubmitButton.textContent = "Crea account";
  }
  if (authErrorLabel) authErrorLabel.textContent = "";
}
if (authToggleLogin) authToggleLogin.onclick = () => setAuthMode("login");
if (authToggleRegister) authToggleRegister.onclick = () => setAuthMode("register");
if (accountBadge) {
  accountBadge.onclick = () => {
    const confirmLogout = confirm("Vuoi cambiare account? (Logout)");
    if (!confirmLogout) return;
    clearCurrentUser();
    showAuthOverlay();
  };
}

/* AUTH SUBMIT */
async function handleAuthSubmit() {
  if (!authUsernameInput || !authPasswordInput) return;
  const username = authUsernameInput.value.trim();
  const password = authPasswordInput.value;

  if (!username || !password) {
    if (authErrorLabel) authErrorLabel.textContent = "Inserisci username e password.";
    return;
  }

  const payload = {
    action: authMode === "register" ? "createUser" : "login",
    username,
    password
  };

  try {
    if (authErrorLabel) authErrorLabel.textContent = "Attendere...";
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => null);
    if (!data || !data.ok) {
      if (authErrorLabel) authErrorLabel.textContent = data && data.error ? data.error : "Errore autenticazione";
      return;
    }
    const userId = data.userId;
    setCurrentUser(userId, username);
    hideAuthOverlay();
    await loadBikers(true);
    showView("home");
  } catch (e) {
    console.error(e);
    if (authErrorLabel) authErrorLabel.textContent = "Errore di rete.";
  }
}
if (authSubmitButton) authSubmitButton.onclick = handleAuthSubmit;

/* PERFORMANCE BUTTON TEXT */
function updateResetPerformanceButton() {
  const btn = document.getElementById("reset-performance-btn");
  if (!btn) return;
  if (performanceMode === "race" && currentRaceSample) btn.textContent = "Cancella";
  else btn.textContent = "Reset";
}

/* LOAD BIKERS */
async function loadBikers(force = false) {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per vedere i tuoi bikers.");
    return [];
  }
  if (!force && window.__bikersCache.length > 0) return window.__bikersCache;
  try {
    const url = API_URL + "?action=getBikers&userId=" + encodeURIComponent(userId);
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Errore rete");
    const text = await res.text();
    const data = JSON.parse(text);
    if (!data.ok) throw new Error(data.error || "Errore API getBikers");
    const bikers = Array.isArray(data.bikers) ? data.bikers : [];
    window.__bikersCache = bikers;
    return bikers;
  } catch (e) {
    console.error(e);
    return window.__bikersCache;
  }
}

/* SAVE BIKERS */
async function saveBikersToServer(bikers) {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per salvare i bikers.");
    return;
  }
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: "saveBikers",
        userId,
        bikers
      })
    });
    const data = await res.json().catch(() => null);
    if (!data || !data.ok) {
      console.error("API saveBikers error", data);
      alert("Errore salvataggio bikers");
      return;
    }
    window.__bikersCache = data.bikers || [];
  } catch (e) {
    console.error(e);
    alert("Errore salvataggio");
  }
}

/* BOTTONI VIEW */
function updateButtonsForView(mode) {
  if (mode === "home") {
    mainButtons.style.display = "none";
    return;
  }

  if (mode === "db") {
    mainButtons.style.display = "none";
    return;
  }

  mainButtons.style.display = "flex";
  mainButtons.style.flexDirection = "column";
  mainButtons.style.justifyContent = "flex-start";

  [btnDb, btnSelect, btnGara, calcBtn, btnReset, saveRaceButton].forEach(b => {
    b.style.display = "none";
    b.style.flex = "";
    b.style.marginLeft = "";
    b.style.marginRight = "";
  });

  btnDb.style.background = "#FDE000"; btnDb.style.color = "#111";
  btnSelect.style.background = "#CC0000"; btnSelect.style.color = "#fff";
  btnGara.style.background = "#CC0000"; btnGara.style.color = "#fff";
  calcBtn.style.background = "#CC0000"; calcBtn.style.color = "#fff";
  btnReset.style.background = "#6b7280"; btnReset.style.color = "#fff";

  calcBtn.textContent = "Calcola classifica";

  if (mode === "select") {
    mainButtons.style.flexDirection = "column";
    if (btnGara) {
      btnGara.style.display = "block";
      btnGara.style.flex = "none";
      btnGara.style.padding = "24px"; // altezza doppia
    }
  } else if (mode === "percent") {
    mainButtons.style.flexDirection = "row";
    mainButtons.style.justifyContent = "space-between";
    btnSelect.style.display = "block";
    calcBtn.style.display = "block";
    calcBtn.textContent = "Conferma dati";
    btnSelect.style.background = "#FDE000"; btnSelect.style.color = "#111";
    btnSelect.style.flex = "1"; calcBtn.style.flex = "1";
    btnSelect.style.marginRight = "4px"; calcBtn.style.marginLeft = "4px";
    // bottoni pi√π alti
    btnSelect.style.padding = "24px";
    calcBtn.style.padding = "24px";
  } else if (mode === "raceinfo") {
    calcBtn.style.display = "block";
    calcBtn.style.padding = "24px"; // tasto alto il doppio
  } else if (mode === "results") {
    // Bottoni risultati: affiancati, pi√π alti e a pillola
    mainButtons.style.flexDirection = "row";
    mainButtons.style.justifyContent = "space-between";

    if (btnReset) {
      btnReset.style.display = "block";
      btnReset.style.background = "#FDE000";
      btnReset.style.color = "#111";
      btnReset.style.flex = "1";
      btnReset.style.marginRight = "6px";
      btnReset.style.borderRadius = "999px"; // pillola
      btnReset.style.padding = "24px";      // altezza doppia
      btnReset.style.fontSize = "20px";     // testo pi√π grande
    }
    if (saveRaceButton) {
      saveRaceButton.style.display = "block";
      saveRaceButton.style.background = "#CC0000";
      saveRaceButton.style.color = "#fff";
      saveRaceButton.style.flex = "1";
      saveRaceButton.style.marginLeft = "6px";
      saveRaceButton.style.borderRadius = "999px"; // pillola
      saveRaceButton.style.padding = "24px";      // altezza doppia
      saveRaceButton.style.fontSize = "20px";     // testo pi√π grande
    }
  } else if (mode === "performance" || mode === "test") {
    mainButtons.style.display = "none";
  }
}

function setActiveSection(elem, shouldShow, useFlex = false) {
  if (!elem) return;
  elem.classList.add("view-section");
  if (shouldShow) {
    elem.style.display = useFlex ? "flex" : "block";
    elem.classList.remove("active-view");
    // forza reflow per permettere la transizione
    void elem.offsetWidth;
    elem.classList.add("active-view");
  } else {
    elem.classList.remove("active-view");
    elem.style.display = "none";
  }
}

function showView(mode) {
  currentView = mode;

  if (mode === "home") document.body.classList.add("home-mode");
  else document.body.classList.remove("home-mode");

  if (homeView) homeView.style.display = (mode === "home") ? "flex" : "none";

  setActiveSection(dbContainer,        mode === "db");
  setActiveSection(selectContainer,    mode === "select");
  setActiveSection(playersContainer,   mode === "percent");
  setActiveSection(raceInfoContainer,  mode === "raceinfo", true);
  setActiveSection(performanceContainer, mode === "performance");
  setActiveSection(testView,           mode === "test");
  setActiveSection(rankingBox,         mode === "results");

  updateButtonsForView(mode);
}

/* DB VIEW */
async function renderDBView() {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per gestire i bikers.");
    return;
  }

  dbContainer.innerHTML = "";

  const bikers = await loadBikers(true);

  if (!bikers || bikers.length === 0) {
    const emptyMsg = document.createElement("div");
    emptyMsg.className = "biker-list-empty";
    emptyMsg.textContent = "Nessun biker presente. Premi \"Nuovo biker\" per aggiungerne uno.";
    dbContainer.appendChild(emptyMsg);
  } else {
    const list = document.createElement("div");
    list.className = "biker-list";

    bikers.forEach((biker, index) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "biker-list-item";

      const initialSpan = document.createElement("span");
      initialSpan.className = "biker-initial";
      const initial = (biker.name || "").trim().charAt(0) || "?";
      initialSpan.textContent = initial.toUpperCase();

      const nameSpan = document.createElement("span");
      nameSpan.className = "biker-name-label";
      nameSpan.textContent = biker.name || ("Biker " + (index + 1));

      btn.appendChild(initialSpan);
      btn.appendChild(nameSpan);

      btn.onclick = () => openBikerModal(index);

      list.appendChild(btn);
    });

    dbContainer.appendChild(list);
  }

  const row = document.createElement("div");
  row.className = "db-buttons-inline";

  const add = document.createElement("button");
  add.className = "btn-small btn-db-add";
  add.textContent = "Nuovo biker";
  add.onclick = () => openBikerModal(null);

  row.appendChild(add);
  dbContainer.appendChild(row);
}

function createDBCard(b) {
  const card = document.createElement("div");
  card.className = "player-card";

  // Compatibilit√†: se arrivano dati vecchi con solo "weight", lo considero come peso biker
  const name        = b ? (b.name        ?? "") : "";
  const batteryWh   = b ? (b.batteryWh   ?? b.battery ?? "") : "";
  const riderWeight = b ? (b.riderKg     ?? b.weight  ?? "") : "";
  const bikeWeight  = b ? (b.bikeKg      ?? "") : "";

  card.innerHTML = `
    <div class="player-title">
      <span>${name || "Nuovo Biker"}</span>
      <button class="delete-biker">‚úï</button>
    </div>
    <input class="name-input" placeholder="Nome" value="${name}">
    <input class="battery-input" type="number" placeholder="Wh batteria" value="${batteryWh}">
    <input class="rider-weight-input" type="number" placeholder="Peso biker (kg)" value="${riderWeight}">
    <input class="bike-weight-input" type="number" placeholder="Peso bici (kg)" value="${bikeWeight}">
  `;

  card.querySelector(".delete-biker").onclick = () => card.remove();

  const btnRow = document.getElementById("db-buttons-inline");
  if (btnRow) dbContainer.insertBefore(card, btnRow);
  else dbContainer.appendChild(card);
}

async function saveDatabaseFromView() {
  const cards = [...dbContainer.getElementsByClassName("player-card")];
  const bikers = cards.map(c => {
    const nameVal        = c.querySelector(".name-input").value.trim();
    const batteryVal     = parseFloat(c.querySelector(".battery-input").value);
    const riderWeightVal = parseFloat(c.querySelector(".rider-weight-input").value);
    const bikeWeightVal  = parseFloat(c.querySelector(".bike-weight-input").value);

    const validName        = !!nameVal;
    const validBattery     = Number.isFinite(batteryVal)     && batteryVal > 0;
    const validRiderWeight = Number.isFinite(riderWeightVal) && riderWeightVal > 0;
    const validBikeWeight  = Number.isFinite(bikeWeightVal)  && bikeWeightVal > 0;

    if (!validName || !validBattery || !validRiderWeight || !validBikeWeight) return null;

    return {
      name:       nameVal,
      batteryWh:  batteryVal,
      riderKg:    riderWeightVal,
      bikeKg:     bikeWeightVal
    };
  }).filter(Boolean);

  if (bikers.length === 0) {
    alert("Inserisci almeno un biker valido (nome, Wh, peso biker, peso bici).");
    return;
  }

  if (bikers.length > MAX_BIKERS) {
    alert("Numero massimo di biker superato (" + MAX_BIKERS + ").");
    return;
  }

  await saveBikersToServer(bikers);
  await renderSelectView();
  showView("select");
}
let currentBikerIndex = null;

function openBikerModal(index) {
  const bikers = window.__bikersCache || [];
  currentBikerIndex = (typeof index === "number") ? index : null;

  if (!bikerModalOverlay) return;

  if (currentBikerIndex === null) {
    bikerModalTitle.textContent = "Nuovo biker";
    bikerModalName.value = "";
    bikerModalBattery.value = "";
    bikerModalRider.value = "65";
    bikerModalBike.value = "15";
    bikerModalBtnDelete.style.display = "none";
  } else {
    const b = bikers[currentBikerIndex];
    bikerModalTitle.textContent = "Modifica biker";
    bikerModalName.value = (b && b.name) ? b.name : "";
    bikerModalBattery.value = (b && b.batteryWh != null) ? b.batteryWh : "";
    bikerModalRider.value = (b && b.riderKg != null) ? b.riderKg : "";
    bikerModalBike.value = (b && b.bikeKg != null) ? b.bikeKg : "";
    bikerModalBtnDelete.style.display = "inline-block";
  }

  bikerModalOverlay.style.display = "flex";
}

function closeBikerModal() {
  if (bikerModalOverlay) bikerModalOverlay.style.display = "none";
  currentBikerIndex = null;
}

async function handleBikerModalSave() {
  const name = bikerModalName.value.trim();
  const batteryVal = parseFloat(bikerModalBattery.value);
  const riderVal = parseFloat(bikerModalRider.value);
  const bikeVal  = parseFloat(bikerModalBike.value);

  if (!name ||
      !Number.isFinite(batteryVal) || batteryVal <= 0 ||
      !Number.isFinite(riderVal)   || riderVal   <= 0 ||
      !Number.isFinite(bikeVal)    || bikeVal    <= 0) {
    alert("Inserisci nome, Wh, peso biker e peso bici validi.");
    return;
  }

  const bikers = Array.isArray(window.__bikersCache) ? [...window.__bikersCache] : [];

  const bikerData = {
    name,
    batteryWh: batteryVal,
    riderKg: riderVal,
    bikeKg: bikeVal
  };

  if (currentBikerIndex === null) {
    if (bikers.length >= MAX_BIKERS) {
      alert("Hai raggiunto il numero massimo di biker (" + MAX_BIKERS + ").");
      return;
    }
    bikers.push(bikerData);
  } else {
    bikers[currentBikerIndex] = bikerData;
  }

  await saveBikersToServer(bikers);
  closeBikerModal();
  await renderDBView();
}

async function handleBikerModalDelete() {
  if (currentBikerIndex === null) {
    closeBikerModal();
    return;
  }

  if (!confirm("Eliminare questo biker dal database?")) return;

  const bikers = Array.isArray(window.__bikersCache) ? [...window.__bikersCache] : [];
  if (currentBikerIndex >= 0 && currentBikerIndex < bikers.length) {
    bikers.splice(currentBikerIndex, 1);
  }

  await saveBikersToServer(bikers);
  closeBikerModal();
  await renderDBView();
}

/* SELECT VIEW */
async function renderSelectView() {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per selezionare i bikers.");
    return;
  }
  selectContainer.innerHTML = "";
  selectedIndices = {};
  const bikers = await loadBikers();
  bikers.forEach((b, i) => createParticipantRow(b, i));
}

function createParticipantRow(b, i) {
  const row = document.createElement("div");
  row.className = "participant-row";
  row.dataset.index = i;
  row.tabIndex = 0;

  const initial = (b.name && b.name.trim().charAt(0))
    ? b.name.trim().charAt(0).toUpperCase()
    : "?";

  const batteryWh   = b.batteryWh ?? b.battery ?? "";
  const riderWeight = b.riderKg   ?? b.weight  ?? "";
  const bikeWeight  = b.bikeKg    ?? "";

  row.innerHTML = `
    <div class="participant-main">
      <div class="participant-avatar">${initial}</div>
      <div class="participant-text">
        <span class="participant-name">${b.name}</span>
        <span class="participant-meta">${batteryWh} Wh ¬∑ ${riderWeight} kg biker ¬∑ ${bikeWeight} kg bici</span>
      </div>
    </div>
  `;

  const toggleSelected = () => {
    selectedIndices[i] = !selectedIndices[i];
    row.classList.toggle("selected");
  };

  row.onclick = toggleSelected;
  row.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      toggleSelected();
    }
  });

  selectContainer.appendChild(row);
}

/* GARA */
function clearPlayersUI() { playersContainer.innerHTML = ""; }

async function buildGaraFromSelection() {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per inserire i dati di gara.");
    return;
  }
  const bikers = await loadBikers();
  clearPlayersUI();
  let any = false;
  Object.keys(selectedIndices).forEach(i => {
    if (selectedIndices[i]) {
      createGaraCard(bikers[i]);
      any = true;
    }
  });
  if (!any) {
    alert("Seleziona almeno un Biker partecipante.");
    return;
  }
  showView("percent");
}

function createGaraCard(b) {
  const batteryWh   = b.batteryWh ?? b.battery ?? "";
  const riderWeight = b.riderKg   ?? b.weight  ?? "";
  const bikeWeight  = b.bikeKg    ?? "";

  const c = document.createElement("div");
  c.className = "player-card";
  c.innerHTML = `
    <div class="player-title"><span>${b.name}</span></div>
    <input type="hidden" class="name-input" value="${b.name}">
    <input type="hidden" class="battery-input" value="${batteryWh}">
    <input type="hidden" class="rider-weight-input" value="${riderWeight}">
    <input type="hidden" class="bike-weight-input" value="${bikeWeight}">
    <input type="number" class="percent-input" placeholder="% residua" min="0" max="100">
  `;
  playersContainer.appendChild(c);
}

/* COLLECT */
function collectResultsFromPercentView() {
  const cards = [...playersContainer.getElementsByClassName("player-card")];
  const results = cards.map(c => {
    const name    = c.querySelector(".name-input").value.trim();
    const battery = parseFloat(c.querySelector(".battery-input").value);
    const riderW  = parseFloat(c.querySelector(".rider-weight-input").value);
    const bikeW   = parseFloat(c.querySelector(".bike-weight-input").value);
    let percent   = parseFloat(c.querySelector(".percent-input").value);

    if (!name) return null;
    if (!Number.isFinite(battery) || battery <= 0) return null;
    if (!Number.isFinite(riderW) || riderW  <= 0) return null;
    if (!Number.isFinite(bikeW)  || bikeW   <= 0) return null;
    if (!Number.isFinite(percent)) return null;

    if (percent < 0) percent = 0;
    if (percent > 100) percent = 100;

    const totalWeight = riderW + bikeW;
    const calc = computeCoyoteScore(battery, totalWeight, percent);
    if (!calc) return null;

    return { name, percent: calc.percent, score: calc.score };
  }).filter(Boolean);

  window.__coyoteResults = results;
}

/* FORMATTARE DATA ITA */
function formatItalianDate(dateStr) {
  if (!dateStr) return "";
  const [year, month, day] = dateStr.split("-");
  const mesi = [
    "gennaio","febbraio","marzo","aprile","maggio","giugno",
    "luglio","agosto","settembre","ottobre","novembre","dicembre"
  ];
  const mIndex = parseInt(month, 10) - 1;
  const nomeMese = mesi[mIndex] || "";
  if (!nomeMese) return dateStr;
  return parseInt(day, 10) + " " + nomeMese + " " + year;
}

function updateRaceDateDisplay() {
  const v = raceDateInput.value;
  raceDateDisplay.textContent = v ? formatItalianDate(v) : "";
}

/* DATE PER PERFORMANCE */
function formatRaceDateForDisplay(raw) {
  if (!raw) return "";
  const s = raw.toString().trim();

  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    return formatItalianDate(s);
  }
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
    const parts = s.split("/");
    const dd = parts[0].padStart(2, "0");
    const mm = parts[1].padStart(2, "0");
    const yyyy = parts[2];
    return formatItalianDate(`${yyyy}-${mm}-${dd}`);
  }
  const d = new Date(s);
  if (!isNaN(d.getTime())) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return formatItalianDate(`${yyyy}-${mm}-${dd}`);
  }
  return s;
}

/* COLORI BATTERIA & CLASSIFICA */
function batteryColorForPercent(p) {
  if (!Number.isFinite(p)) return "#9ca3af";
  if (p < 25) return "#ef4444";
  if (p < 50) return "#f97316";
  if (p < 75) return "#eab308";
  return "#22c55e";
}

function calculate() {
  const results = window.__coyoteResults || [];

  const dateVal = raceDateInput.value;
  const circuito = raceCircuitInput.value.trim();
  const km = raceDistanceInput.value.trim();
  const disl = raceElevationInput.value.trim();

  const formattedDate = dateVal ? formatItalianDate(dateVal) : "";

  let headerText = "";
  if (formattedDate && circuito) headerText = circuito + " - " + formattedDate;
  else if (formattedDate) headerText = formattedDate;
  else if (circuito) headerText = circuito;

  raceDateDisplay.textContent = headerText;
  raceDistanceDisplay.textContent = km ? km + " km" : "";
  raceElevationDisplay.textContent = disl ? disl + " m" : "";

  showView("results");
  rankingList.innerHTML = "";

  if (!results.length) {
    const li = document.createElement("li");
    li.textContent = "Nessun dato valido. Inserisci le %.";
    rankingList.appendChild(li);
    return;
  }

  results.sort((a, b) => b.score - a.score);

  results.forEach((r, i) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="result-left">
        <div class="result-topline">
          <span class="position-number">${i + 1}</span>
          <span class="result-name">${r.name || "Biker"}</span>
        </div>
        <div class="battery-row">
          <div class="battery">
            <div class="battery-level" style="background:${batteryColorForPercent(r.percent)}"></div>
            <span class="battery-percent-label">${r.percent}%</span>
          </div>
        </div>
      </div>
      <div class="result-right">
        <div class="right-topline">
          <span class="medal">${["ü•á","ü•à","ü•â"][i] || "üèÅ"}</span>
          <span class="result-score">${r.score.toFixed(2)}</span>
        </div>
      </div>
    `;

    const level = li.querySelector(".battery-level");
    setTimeout(() => {
      const safePercent = Number.isFinite(r.percent) ? r.percent : 0;
      level.style.width = (Math.round(safePercent / 4) * 4) + "%";
    }, 50);

    rankingList.appendChild(li);
  });
}

/* MENU ICON */
const menuIcon = document.getElementById("menu-icon");
if (menuIcon) {
  menuIcon.onclick = () => showView("home");
  menuIcon.onkeydown = (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      showView("home");
    }
  };
}

/* HOME BUTTONS */
if (homeBtnRace) {
  homeBtnRace.onclick = async () => {
    await renderSelectView();
    showView("select");
  };
}
if (homeBtnPerformance) {
  homeBtnPerformance.onclick = () => loadPerformanceView();
}
if (homeBtnTest) {
  homeBtnTest.onclick = () => {
    initTestView();
    showView("test");
  };
}

if (document.getElementById("home-btn-account")) {
  document.getElementById("home-btn-account").onclick = () => {
    const uid = getCurrentUserId();
    const username = getCurrentUsername();

    // Se NON loggato ‚Üí apri login
    if (!uid) {
      showAuthOverlay();
      return;
    }

    // Se loggato ‚Üí chiedi logout
    const confirmLogout = confirm("Sei gi√† connesso come " + (username ? ("@" + username) : uid) + ". Vuoi eseguire il logout?");
    if (confirmLogout) {
      clearCurrentUser();            // rimuove userId e username
      alert("Logout eseguito.");     // feedback
      showAuthOverlay();             // torna alla schermata di login
    }
  };
}

const homeAccountPillEl = document.getElementById("home-account-pill");
if (homeAccountPillEl) {
  // Click sul pill account: login / logout
  homeAccountPillEl.onclick = () => {
    const uid = getCurrentUserId();
    const username = getCurrentUsername();

    // Se NON loggato ‚Üí apri login
    if (!uid) {
      showAuthOverlay();
      return;
    }

    // Se loggato ‚Üí chiedi logout
    const confirmLogout = confirm("Sei gi√† connesso come " + (username ? ("@" + username) : uid) + ". Vuoi eseguire il logout?");
    if (confirmLogout) {
      clearCurrentUser();
      alert("Logout eseguito.");
      showAuthOverlay();
    }
  };

  // Accessibilit√† tastiera: Invio/Spazio attivano il click
  homeAccountPillEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      homeAccountPillEl.click();
    }
  });
}

if (homeBtnBikers) {
  homeBtnBikers.onclick = async () => {
    showBikersLoading();
    try {
      await renderDBView();
      showView("db");
    } finally {
      hideBikersLoading();
    }
  };
}


/* PULSANTI MODALE BIKER */
if (bikerModalBtnSave)   bikerModalBtnSave.onclick   = () => handleBikerModalSave();
if (bikerModalBtnDelete) bikerModalBtnDelete.onclick = () => handleBikerModalDelete();
if (bikerModalBtnCancel) bikerModalBtnCancel.onclick = () => closeBikerModal();

/* MAIN BUTTONS */
btnDb.onclick = () => { renderDBView(); showView("db"); };
btnSelect.onclick = () => { renderSelectView(); showView("select"); };
btnGara.onclick = () => buildGaraFromSelection();

calcBtn.onclick = () => {
  if (currentView === "percent") {
    collectResultsFromPercentView();
    if (!window.__coyoteResults || !window.__coyoteResults.length) {
      alert("Inserisci almeno una percentuale valida.");
      return;
    }
    showView("raceinfo");
  } else if (currentView === "raceinfo") {
    calculate();
  }
};

btnReset.onclick = () => {
  rankingList.innerHTML = "";
  raceDateInput.value = "";
  raceCircuitInput.value = "";
  raceDistanceInput.value = "";
  raceElevationInput.value = "";
  raceDateDisplay.textContent = "";
  raceDistanceDisplay.textContent = "";
  raceElevationDisplay.textContent = "";
  window.__coyoteResults = [];
  selectedIndices = {};
  renderSelectView();
  showView("select");
};

/* INVIO GARA AL DB ‚Äì POST text/plain con no-cors */
async function sendRaceToDatabase() {
  if (!window.__coyoteResults || !window.__coyoteResults.length) {
    alert("Prima calcola la classifica (score) per la gara.");
    return;
  }

  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per salvare le gare.");
    return;
  }

  const dateVal = raceDateInput.value;
  const circuito = (raceCircuitInput.value || "").trim();
  const km = parseFloat(raceDistanceInput.value) || 0;
  const disl = parseFloat(raceElevationInput.value) || 0;

  const payload = {
    action: "saveRace",
    userId,
    race: {
      date: dateVal || "",
      circuit: circuito || "",
      km: km,
      elevation: disl,
      results: window.__coyoteResults
    }
  };

  try {
    await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(payload)
    });

    alert("Gara inviata al nuovo database (controlla il foglio Google).");
  } catch (e) {
    console.error(e);
    alert("Errore di rete nell'invio della gara al database.");
  }
}
if (saveRaceButton) saveRaceButton.onclick = sendRaceToDatabase;

/* PERFORMANCE: MEDIE */
function computeWeightedAveragesByKm(races) {
  const bikerStats = {};
  (races || []).forEach(r => {
    const name = r.name;
    const score = Number(r.score);
    if (!name || !Number.isFinite(score)) return;

    const kmVal = Number(r.km);
    const weight = Number.isFinite(kmVal) && kmVal > 0 ? kmVal : 1;

    if (!bikerStats[name]) bikerStats[name] = { wsum: 0, wtot: 0 };
    bikerStats[name].wsum += score * weight;
    bikerStats[name].wtot += weight;
  });

  return Object.entries(bikerStats).map(([name, s]) => ({
    name,
    avg: s.wtot > 0 ? (s.wsum / s.wtot) : 0
  }));
}

function renderPerformanceBars(entries) {
  if (!performanceBars) return;

  if (!entries || !entries.length) {
    performanceBars.innerHTML = "";
    if (performanceEmpty) {
      performanceEmpty.textContent = "Nessun dato valido.";
      performanceEmpty.style.display = "block";
    }
    return;
  }

  const maxScore = Math.max(...entries.map(e => e[1])) || 1;
  performanceBars.innerHTML = "";
  if (performanceEmpty) performanceEmpty.style.display = "none";

  entries.sort((a, b) => b[1] - a[1]);
  const lastIndex = entries.length - 1;

  entries.forEach((entry, index) => {
    const [name, total] = entry;

    const bar = document.createElement("div");
    bar.style.flex = "1";
    bar.style.minWidth = "24px";
    bar.style.display = "flex";
    bar.style.flexDirection = "column";
    bar.style.alignItems = "center";
    bar.style.justifyContent = "flex-end";

    const medal = document.createElement("div");
    let medalEmoji = "";
    if (index === 0) medalEmoji = "ü•á";
    else if (index === 1) medalEmoji = "ü•à";
    else if (index === 2) medalEmoji = "ü•â";
    else if (index === lastIndex) medalEmoji = "üçó";
    medal.textContent = medalEmoji;
    medal.style.fontSize = "32px";
    medal.style.marginBottom = "2px";
    if (!medalEmoji) medal.style.visibility = "hidden";

    const val = document.createElement("div");
    val.textContent = total.toFixed(2);
    val.style.fontSize = "12px";
    val.style.color = "#dc2626";
    val.style.fontWeight = "700";
    val.style.marginBottom = "2px";

    const inner = document.createElement("div");
    inner.style.width = "100%";
    inner.style.borderRadius = "6px 6px 0 0";
    inner.style.background = "linear-gradient(to top, #CC0000, #F97316)";
    inner.style.height = "0%";

    const label = document.createElement("div");
    label.textContent = name;
    label.style.fontSize = "11px";
    label.style.color = "#111827";
    label.style.marginTop = "4px";
    label.style.textAlign = "center";
    label.style.whiteSpace = "nowrap";
    label.style.overflow = "hidden";
    label.style.textOverflow = "ellipsis";

    bar.appendChild(medal);
    bar.appendChild(val);
    bar.appendChild(inner);
    bar.appendChild(label);
    performanceBars.appendChild(bar);

    requestAnimationFrame(() => {
      const h = Math.max(6, (total / maxScore) * 100);
      inner.style.height = h + "%";
    });
  });
}

function updatePerformanceRaceHeader(raceSample) {
  if (!performanceRaceHeader) return;

  if (!raceSample) {
    performanceRaceHeader.style.display = "none";
    if (perfRaceDateDisplay) perfRaceDateDisplay.textContent = "";
    if (perfRaceDistanceDisplay) perfRaceDistanceDisplay.textContent = "";
    if (perfRaceElevationDisplay) perfRaceElevationDisplay.textContent = "";
    return;
  }

  const rawDate = getRaceDateString(raceSample);
  const circuit = (raceSample.circuit || "").toString().trim();
  const kmVal = Number(raceSample.km);
  const elevVal = Number(raceSample.elevation || 0);

  const dateText = formatRaceDateForDisplay(rawDate);
  let headerText = "";
  if (circuit && dateText) headerText = circuit + " - " + dateText;
  else if (dateText) headerText = dateText;
  else if (circuit) headerText = circuit;

  if (perfRaceDateDisplay) perfRaceDateDisplay.textContent = headerText;
  if (perfRaceDistanceDisplay) {
    perfRaceDistanceDisplay.textContent = Number.isFinite(kmVal) && kmVal > 0 ? kmVal + " km" : "";
  }
  if (perfRaceElevationDisplay) {
    perfRaceElevationDisplay.textContent = Number.isFinite(elevVal) && elevVal > 0 ? elevVal + " m" : "";
  }

  performanceRaceHeader.style.display = "block";
}

function renderPerformanceOverall() {
  performanceMode = "overall";
  currentRaceSample = null;
  updateResetPerformanceButton();

  const races = allRaces || [];
  if (!races.length) {
    if (performanceEmpty) {
      performanceEmpty.textContent = "Nessuna gara registrata.";
      performanceEmpty.style.display = "block";
    }
    if (performanceBars) performanceBars.innerHTML = "";
    updatePerformanceRaceHeader(null);
    return;
  }

  if (performanceTitle && performanceSubtitle) {
    performanceTitle.textContent = "Performance complessive";
    performanceSubtitle.textContent = "Media pesata delle performance su tutte le gare per ogni biker.";
  }

  const avgsArr = computeWeightedAveragesByKm(races);
  const entries = avgsArr.map(e => [e.name, e.avg]);
  renderPerformanceBars(entries);
  updatePerformanceRaceHeader(null);
}

function getRaceDateString(r) {
  if (!r) return "";
  return (r.date || r.data || r.raceDate || r.garaDate || r.gara || "").toString().trim();
}

function renderPerformanceForRaceFilter(query) {
  const races = allRaces || [];
  if (!races.length) {
    alert("Nessuna gara registrata nel database.");
    updatePerformanceRaceHeader(null);
    return;
  }
  const q = (query || "").trim().toLowerCase();
  if (!q) return;

  const filtered = races.filter(r => {
    const d = getRaceDateString(r).toLowerCase();
    const c = (r.circuit || "").toString().toLowerCase();
    return d === q || d.includes(q) || c.includes(q);
  });

  if (!filtered.length) {
    alert("Nessuna gara trovata per: " + query);
    updatePerformanceRaceHeader(null);
    return;
  }

  performanceMode = "race";
  currentRaceSample = filtered[0] || null;
  updateResetPerformanceButton();

  if (performanceTitle && performanceSubtitle) {
    performanceTitle.textContent = "Gara specifica";
    performanceSubtitle.textContent = "";
  }

  const avgsArr = computeWeightedAveragesByKm(filtered);
  const entries = avgsArr.map(e => [e.name, e.avg]);
  renderPerformanceBars(entries);

  updatePerformanceRaceHeader(filtered[0]);
}

/* CALENDARIO GARE */
function openRaceCalendar() {
  const races = allRaces || [];
  if (!races.length) {
    alert("Nessuna gara registrata nel database.");
    return;
  }
  if (!raceCalendar) return;

  const datesMap = new Map();

  
function normalizeDate(str) {
    if (!str) return null;
    const s = str.trim();
    let y, m, d;

    // Caso con timestamp: usiamo direttamente l'oggetto Date in locale
    if (s.includes("T")) {
      const dt = new Date(s);
      if (isNaN(dt.getTime())) return null;
      y = dt.getFullYear();
      m = dt.getMonth() + 1;
      d = dt.getDate();
    }
    // Formato ISO solo data: 2025-11-30
    else if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
      const parts = s.split("-");
      y = parseInt(parts[0], 10);
      m = parseInt(parts[1], 10);
      d = parseInt(parts[2], 10);
    }
    // Formato europeo: 30/11/2025
    else if (s.includes("/")) {
      const parts = s.split("/");
      if (parts.length !== 3) return null;
      d = parseInt(parts[0], 10);
      m = parseInt(parts[1], 10);
      y = parseInt(parts[2], 10);
    } else {
      return null;
    }

    if (!y || !m || !d) return null;

    // Nessun offset: usiamo la data cos√¨ com'√®
    const fy = y;
    const fm = m;
    const fd = d;

    return {
      y: fy,
      m: fm,
      d: fd,
      ymd: String(fy).padStart(4, "0") + "-" +
           String(fm).padStart(2, "0") + "-" +
           String(fd).padStart(2, "0")
    };
  }

  races.forEach(r => {
    const raw = getRaceDateString(r);
    if (!raw) return;
    const norm = normalizeDate(raw);
    if (!norm) return;
    const key = norm.ymd;
    if (!datesMap.has(key)) {
      datesMap.set(key, { rawDates: new Set(), races: [] });
    }
    const entry = datesMap.get(key);
    entry.rawDates.add(raw);
    entry.races.push(r);
  });

  if (!datesMap.size) {
    alert("Nessuna data valida trovata nel database.");
    return;
  }

  const allKeys = Array.from(datesMap.keys());
  const parsed = allKeys.map(ymd => {
    const [y, m, d] = ymd.split("-");
    return {
      y: parseInt(y, 10) || new Date().getFullYear(),
      m: (parseInt(m, 10) || 1),
      d: (parseInt(d, 10) || 1),
      ymd
    };
  });

  let minYear = Math.min(...parsed.map(p => p.y));
  let maxYear = Math.max(...parsed.map(p => p.y));
  if (!Number.isFinite(minYear) || !Number.isFinite(maxYear)) {
    minYear = new Date().getFullYear();
    maxYear = minYear;
  }

  const last = parsed[parsed.length - 1];
  let currentYear = last.y;
  let currentMonth = last.m - 1;

  raceCalendar.innerHTML = "";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.alignItems = "center";
  header.style.justifyContent = "space-between";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.style.fontWeight = "700";
  title.style.fontSize = "14px";
  title.textContent = "Seleziona una gara";
  header.appendChild(title);

  const closeBtn = document.createElement("button");
  closeBtn.type = "button";
  closeBtn.textContent = "‚úï";
  closeBtn.style.border = "none";
  closeBtn.style.background = "transparent";
  closeBtn.style.cursor = "pointer";
  closeBtn.style.fontSize = "14px";
  closeBtn.style.fontWeight = "700";
  closeBtn.onclick = () => raceCalendar.style.display = "none";
  header.appendChild(closeBtn);

  raceCalendar.appendChild(header);

  const controlRow = document.createElement("div");
  controlRow.style.display = "flex";
  controlRow.style.alignItems = "center";
  controlRow.style.justifyContent = "center";
  controlRow.style.gap = "6px";
  controlRow.style.marginBottom = "8px";

  const prevBtn = document.createElement("button");
  prevBtn.type = "button";
  prevBtn.textContent = "‚óÄ";
  prevBtn.style.border = "none";
  prevBtn.style.borderRadius = "999px";
  prevBtn.style.padding = "4px 8px";
  prevBtn.style.cursor = "pointer";
  prevBtn.style.background = "#fed7aa";
  prevBtn.style.color = "#7c2d12";

  const nextBtn = document.createElement("button");
  nextBtn.type = "button";
  nextBtn.textContent = "‚ñ∂";
  nextBtn.style.border = "none";
  nextBtn.style.borderRadius = "999px";
  nextBtn.style.padding = "4px 8px";
  nextBtn.style.cursor = "pointer";
  nextBtn.style.background = "#fed7aa";
  nextBtn.style.color = "#7c2d12";

  const monthLabel = document.createElement("div");
  monthLabel.style.fontWeight = "600";
  monthLabel.style.fontSize = "13px";

  controlRow.appendChild(prevBtn);
  controlRow.appendChild(monthLabel);
  controlRow.appendChild(nextBtn);

  raceCalendar.appendChild(controlRow);

  const weekRow = document.createElement("div");
  weekRow.style.display = "grid";
  weekRow.style.gridTemplateColumns = "repeat(7, 1fr)";
  weekRow.style.fontSize = "10px";
  weekRow.style.textAlign = "center";
  weekRow.style.marginBottom = "4px";
  weekRow.style.color = "#6b7280";

  const giorni = ["L","M","M","G","V","S","D"];
  giorni.forEach(g => {
    const cell = document.createElement("div");
    cell.textContent = g;
    weekRow.appendChild(cell);
  });

  raceCalendar.appendChild(weekRow);

  const grid = document.createElement("div");
  grid.style.display = "grid";
  grid.style.gridTemplateColumns = "repeat(7, 1fr)";
  grid.style.gap = "2px";
  raceCalendar.appendChild(grid);

  const mesiNomi = [
    "Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
    "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"
  ];

  function buildMonth(year, month) {
    grid.innerHTML = "";
    monthLabel.textContent = mesiNomi[month] + " " + year;

    const firstDay = new Date(year, month, 1);
    const firstWeekday = (firstDay.getDay() + 6) % 7;
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstWeekday; i++) {
      const empty = document.createElement("div");
      empty.textContent = "";
      grid.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement("button");
      cell.type = "button";
      cell.textContent = String(day);
      cell.style.border = "none";
      cell.style.borderRadius = "8px";
      cell.style.padding = "4px 0";
      cell.style.fontSize = "11px";
      cell.style.cursor = "pointer";
      cell.style.minHeight = "28px";

      const mm = String(month + 1).padStart(2, "0");
      const dd = String(day).padStart(2, "0");
      const ymd = String(year).padStart(4, "0") + "-" + mm + "-" + dd;

      if (datesMap.has(ymd)) {
        const entry = datesMap.get(ymd);
        const count = entry.races.length;
        cell.style.background = "#fed7aa";
        cell.style.color = "#7c2d12";
        cell.style.fontWeight = "700";
        cell.title = formatItalianDate(ymd) + (count > 1 ? " (" + count + " gare)" : " (1 gara)");
      } else {
        cell.style.background = "transparent";
        cell.style.color = "#6b7280";
      }

      cell.onclick = () => {
        if (!datesMap.has(ymd)) return;
        const entry = datesMap.get(ymd);
        const rawArr = Array.from(entry.rawDates);
        const query = rawArr[0] || ymd;
        renderPerformanceForRaceFilter(query);
        raceCalendar.style.display = "none";
      };

      grid.appendChild(cell);
    }
  }

  prevBtn.onclick = () => {
    currentMonth -= 1;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear -= 1;
    }
    if (currentYear < minYear) {
      currentYear = minYear;
      currentMonth = 0;
    }
    buildMonth(currentYear, currentMonth);
  };

  nextBtn.onclick = () => {
    currentMonth += 1;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear += 1;
    }
    if (currentYear > maxYear) {
      currentYear = maxYear;
      currentMonth = 11;
    }
    buildMonth(currentYear, currentMonth);
  };

  buildMonth(currentYear, currentMonth);
  raceCalendar.style.display = "block";
}

/* PERFORMANCE GRAPH SIMPLE */
function renderPerformanceGraph(races) {
  const graph = document.getElementById("performance-graph");
  if (!graph) return;
  graph.innerHTML = "";

  const avgsArr = computeWeightedAveragesByKm(races || []);
  if (!avgsArr.length) return;

  const maxVal = Math.max(...avgsArr.map(o => o.avg), 1);

  avgsArr.forEach(({ name, avg }) => {
    const bar = document.createElement("div");
    bar.style.height = (150 * avg / maxVal) + "px";
    bar.style.width = "20px";
    bar.style.background = "linear-gradient(to top, #CC0000, #F97316)";
    bar.style.borderRadius = "4px";
    bar.title = name + ": " + avg.toFixed(2);

    const label = document.createElement("div");
    label.style.textAlign = "center";
    label.style.fontSize = "10px";
    label.style.whiteSpace = "nowrap";
    label.style.overflow = "hidden";
    label.style.textOverflow = "ellipsis";
    label.style.marginTop = "4px";
    label.textContent = name;

    const container = document.createElement("div");
    container.style.display = "flex";
    container.style.flexDirection = "column";
    container.style.alignItems = "center";
    container.appendChild(bar);
    container.appendChild(label);
    graph.appendChild(container);
  });
}

/* LOAD PERFORMANCE */

/* POPUP LOADING PERFORMANCE */
function showLoadingPopup() {
  if (loadingPopupOverlay) {
    loadingPopupOverlay.style.display = "flex";
  }
}
function hideLoadingPopup() {
  if (loadingPopupOverlay) {
    loadingPopupOverlay.style.display = "none";
  }
}

async function loadPerformanceView() {
  const userId = getCurrentUserId();
  if (!userId) {
    showAuthOverlay("Effettua il login per vedere le performance.");
    return;
  }

  showView("performance");
  if (!performanceBars) return;

  // Mostra popup di loading
  showLoadingPopup();

  performanceBars.innerHTML = "";
  if (performanceEmpty) {
    performanceEmpty.textContent = "";
    performanceEmpty.style.display = "none";
  }

  try {
    const url = API_URL + "?action=getRaces&userId=" + encodeURIComponent(userId);
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const txt = await res.text();
    const data = JSON.parse(txt);
    if (!data.ok) throw new Error(data.error || "Errore API getRaces");

    const racesRaw = data.races || [];

    const racesFlat = [];
    racesRaw.forEach(race => {
      const kmVal = Number(race.km) || 0;
      const elevVal = Number(race.elevation) || 0;
      (race.results || []).forEach(resBiker => {
        racesFlat.push({
          raceId: race.raceId,
          userId: race.userId,
          date: race.date,
          circuit: race.circuit,
          km: kmVal,
          elevation: elevVal,
          name: resBiker.name,
          score: Number(resBiker.score)
        });
      });
    });

    allRaces = racesFlat;
    renderPerformanceGraph(racesFlat);

    if (!racesFlat.length) {
      hideLoadingPopup();
      if (performanceEmpty) {
        performanceEmpty.textContent = "Nessuna gara registrata.";
        performanceEmpty.style.display = "block";
      }
      updatePerformanceRaceHeader(null);
      return;
    }

    renderPerformanceOverall();
    hideLoadingPopup();
  } catch (e) {
    console.error(e);
    hideLoadingPopup();
    if (performanceEmpty) {
      performanceEmpty.textContent = "Errore nel caricamento delle performance.";
      performanceEmpty.style.display = "block";
    }
    updatePerformanceRaceHeader(null);
  }
}

/* TEST VIEW */
function initTestView() {
  if (!testRankingList) return;
  testRankingList.innerHTML = "";

  const li = document.createElement("li");
  li.innerHTML = `
    <div class="result-left">
      <div class="battery-row">
        <div class="battery">
          <div class="battery-level" style="width:0%; background:#9ca3af;"></div>
          <span class="battery-percent-label">--%</span>
        </div>
      </div>
      
      </div>
    </div>
    <div class="result-right">
      <div class="right-topline">
        <span class="medal">üèÅ</span>
        <span class="result-score">0.0</span>
      </div>
    </div>
  `;
  testRankingList.appendChild(li);

  if (testBatteryInput) testBatteryInput.value = "";
  if (testWeightInput) testWeightInput.value = "";
  if (testPercentInput) testPercentInput.value = "";

  testTabs.forEach(tab => tab.classList.remove("active"));
  testTabContents.forEach(c => c.classList.remove("active"));
  const firstTab = document.querySelector('.test-tab[data-tab="wh"]');
  const firstContent = document.querySelector('.test-tab-content[data-tab="wh"]');
  if (firstTab) firstTab.classList.add("active");
  if (firstContent) firstContent.classList.add("active");
}

testTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    const target = tab.getAttribute("data-tab");
    testTabs.forEach(t => t.classList.remove("active"));
    testTabContents.forEach(c => c.classList.remove("active"));
    tab.classList.add("active");
    const contentEl = document.querySelector('.test-tab-content[data-tab="' + target + '"]');
    if (contentEl) contentEl.classList.add("active");
  });
});

function calculateTest() {
  if (!testRankingList) return;

  const battery = parseFloat(testBatteryInput.value);
  const riderWeight = parseFloat(testWeightInput.value);
  const bikeWeight = parseFloat(testBikeWeightInput.value);
  let percent = parseFloat(testPercentInput.value);

  if (!Number.isFinite(battery) || battery <= 0 ||
      !Number.isFinite(riderWeight)  || riderWeight  <= 0 ||
      !Number.isFinite(bikeWeight)   || bikeWeight   <= 0 ||
      !Number.isFinite(percent)) {
    alert("Inserisci Wh, peso biker, peso bici e % residua validi per il biker di test.");
    return;
  }

  const totalWeight = riderWeight + bikeWeight;

  if (percent < 0) percent = 0;
  if (percent > 100) percent = 100;

  const calc = computeCoyoteScore(battery, totalWeight, percent);
  if (!calc) {
    alert("Errore nel calcolo (dati non validi).");
    return;
  }

  const consumedWh = calc.consumedWh;
  const efficiencyWhPerKg = calc.efficiencyWhPerKg;
  const score = calc.score;
  percent = calc.percent;

  // Costruiamo la card di test come una "finta" prima posizione
  testRankingList.innerHTML = "";
  const li = document.createElement("li");
  li.innerHTML = `
    <div class="result-left">
      <div class="result-topline"></div>
      <div class="battery-row">
        <div class="battery">
          <div class="battery-level"></div>
          <div class="battery-percent-label"></div>
        </div>
        <span class="scenario-badge" id="test-scenario-display"></span>
      </div>
    </div>
    <div class="result-right">
      <div class="right-topline">
        <span class="medal">üèÅ</span>
        <span class="result-score">--</span>
      </div>
    </div>
  `;
  testRankingList.appendChild(li);

  const levelElem = li.querySelector(".battery-level");
  const percentLabel = li.querySelector(".battery-percent-label");
  const scoreElem = li.querySelector(".result-score");
  const medalElem = li.querySelector(".medal");

  if (percentLabel) percentLabel.textContent = Math.round(percent) + "%";
  if (scoreElem) scoreElem.textContent = score.toFixed(2);
  if (medalElem) medalElem.textContent = "üèÅ";

  // Update external pills: batteria, peso ciclista, percentuale
  const outWh = document.getElementById("pill-out-wh");
  const outKg = document.getElementById("pill-out-kg");
const outBikeKg = document.getElementById("pill-out-bikekg");
  const outP = document.getElementById("pill-out-percent");
  if (outWh && Number.isFinite(battery)) outWh.textContent = battery.toFixed(0) + " Wh";
  if (outKg && Number.isFinite(riderWeight)) outKg.textContent = riderWeight.toFixed(1) + " kg";
outBikeKg.textContent = bikeWeight.toFixed(1) + " kg";
  if (outP && Number.isFinite(percent)) outP.textContent = Math.round(percent) + " %";

  if (levelElem) {
    levelElem.style.background = batteryColorForPercent(percent);
    requestAnimationFrame(() => {
      levelElem.style.width = (Math.round(percent / 4) * 4) + "%";
    });
  }

  const scenarioSpan = document.getElementById("test-scenario-display");
  if (scenarioSpan && Number.isFinite(consumedWh) && efficiencyWhPerKg > 0) {
    const eff = efficiencyWhPerKg.toFixed(1);
    scenarioSpan.textContent = eff + " Wh/kg";
  }
}

if (testCalcBtn) testCalcBtn.onclick = calculateTest;
if (testResetBtn) testResetBtn.onclick = () => initTestView();

/* PERFORMANCE BUTTONS */
if (performanceOverallBtn) performanceOverallBtn.onclick = () => {
  showLoadingPopup();
  setTimeout(() => {
    renderPerformanceOverall();
    hideLoadingPopup();
  }, 50);
};
if (performanceRaceBtn) performanceRaceBtn.onclick = () => openRaceCalendar();

/* SERVICE WORKER */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker
      .register("service-worker.js")
      .catch(function (err) {
        console.log("Service Worker registration failed:", err);
      });
  });
}

/* RESET/CANCELLA PERFORMANCE DB */
const resetBtn = document.getElementById("reset-performance-btn");
if (resetBtn) {
  resetBtn.onclick = async () => {
    const userId = getCurrentUserId();
    if (!userId) {
      showAuthOverlay("Effettua il login per modificare il database performance.");
      return;
    }

    if (performanceMode === "race" && currentRaceSample && currentRaceSample.raceId) {
      const conferma = confirm("Vuoi cancellare DEFINITIVAMENTE questa gara dal database PERFORMANCE?");
      if (!conferma) return;
      const pwd = prompt("Inserisci password per cancellare la gara:");
      if (pwd !== "Coyote") { alert("Password errata."); return; }
      try {
        await fetch(API_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {"Content-Type":"text/plain"},
          body: JSON.stringify({
            action: "deleteRace",
            userId,
            raceId: currentRaceSample.raceId,
            adminPassword: pwd
          })
        });
        alert("Gara cancellata dal nuovo database (controlla il foglio Google).");
        await loadPerformanceView();
      } catch (e) {
        console.error(e);
        alert("Errore nella cancellazione della gara.");
      }
      return;
    }

    const pwd = prompt("Inserisci password per resettare il database (dati performance di questo utente):");
    if (pwd !== "Coyote") { alert("Password errata."); return; }
    try {
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type":"text/plain"},
        body: JSON.stringify({
          action: "resetPerformance",
          userId,
          adminPassword: pwd
        })
      });
      alert("Nuovo database resettato per questo utente. Controlla il foglio Google.");
      await loadPerformanceView();
    } catch(e) {
      console.error(e);
      alert("Errore nel reset.");
    }
  };
}

/* INIT */
async function init() {
  updateAccountBadge();
  updateRaceDateDisplay();

  const userId = getCurrentUserId();

  if (!userId) {
    showAuthOverlay();
    showView("home");
  } else {
    await loadBikers();
    showView("home");
  }

  clearInterval(loadingInterval);
  const loadingScreen = document.getElementById("loading-screen");
  if (loadingScreen) loadingScreen.style.display = "none";
  const container = document.querySelector(".container");
  if (container) container.style.opacity = "1";
}

init();
</script>

</body>
</html>
  